# AI药膳微信小程序接口文档

## 一、项目概述
本项目为AI药膳微信小程序的后端服务，基于Spring Boot框架开发，核心功能是根据用户体质标签、饮食禁忌、口味偏好等信息，提供个性化药膳推荐服务。系统集成了用户管理、微信登录、JWT认证、阿里云OSS文件上传等功能，支持食材/药膳查询、个性化推荐、用户偏好设置等核心场景。

## 二、基础信息

- **接口前缀**：所有接口路径以 `/api` 为前缀（实际部署可配置，当前代码中为 `/user` 等直接路径）
- **数据格式**：请求与响应均采用JSON格式
- **认证方式**：JWT令牌认证（登录后接口需在请求头携带 `token`，格式：`Bearer {token}`）
- **响应格式**：统一使用 `Result<T>` 封装
  ```json
  {
    "code": 1,  // 1成功，0失败
    "msg": "操作成功",  // 错误时返回具体信息
    "data": {}  // 业务数据（成功时返回）
  }
  ```


## 三、核心接口模块

### 1. 用户管理接口

#### 1.1 微信登录（获取Token）

- **路径**：`/user/wx/login`
- **方法**：POST
- **描述**：通过微信小程序登录凭证 `code` 获取用户信息及JWT令牌
- **请求体**：
  
  ```json
  {
    "code": "微信登录临时code"  // 从小程序端wx.login()获取
  }
  ```
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "登录成功",
    "data": {
      "id": 1001,  // 用户ID
      "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",  // 微信openid
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  // JWT令牌
    }
  }
  ```

#### 1.2 普通用户注册登录（手机号绑定）//后端开发使用

- **路径**：`/user/register`
- **方法**：POST
- **描述**：用户补充手机号等信息完成注册
- **请求头**：`authentication: Bearer {token}`
- **请求体**：
  ```json
  {
    "phone": "13800138000",  // 手机号
    "password": "123456"
  }
  ```
- **响应示例**：
  
  ```json
  {
    "code": 1,
    "msg": "注册成功",
    "data": null
  }
  ```

#### 1.3 获取当前用户信息

- **路径**：`/user/profile`
- **方法**：GET
- **描述**：获取登录用户的基本信息及偏好设置
- **请求头**：`authentication: Bearer {token}`
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "操作成功",
    "data": {
      "userId": 1001,
      "nickname": "药膳爱好者",
      "phone": "13800138000",
      "avatarUrl": "https://xxx.com/avatar.jpg",
      "physiqueTags": "阴虚,火旺",  // 体质标签
      "dietaryRestrictions": "海鲜,辛辣",  // 饮食禁忌
      "tastePreferences": "清淡,甜味"  // 口味偏好
    }
  }
  ```

#### 1.4 更新用户偏好设置
- **路径**：`/user/preferences`
- **方法**：PUT
- **描述**：更新用户体质标签、饮食禁忌、口味偏好（用于个性化推荐）
- **请求头**：`authentication: Bearer {token}`
- **请求体**：
  ```json
  {
    "physiqueTags": "阳虚,体寒",
    "dietaryRestrictions": "生冷,油腻",
    "tastePreferences": "温热,微咸"
  }
  ```
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "偏好设置更新成功",
    "data": null
  }
  ```

### 2. 药膳推荐接口

#### 2.1 个性化药膳推荐

- **路径**：`/yaoshan/recommend`
- **方法**：GET
- **描述**：根据用户体质、禁忌和偏好，AI推荐适合的药膳
- **请求头**：`authentication: Bearer {token}`
- **请求参数**（URL查询参数）：
  
  - `pageNum`：页码（默认1）
  - `pageSize`：每页条数（默认10）
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "推荐成功",
    "data": {
      "total": 20,  // 总条数
      "rows": [
        {
          "id": 101,
          "name": "当归红枣乌鸡汤",
          "effect": "补血益气，适合阳虚体质",
          "ingredients": "乌鸡、当归、红枣、枸杞",
          "cookMethod": "炖煮1.5小时",
          "avoid人群": "湿热体质者慎食"
        }
      ]
    }
  }
  ```

#### 2.2 按食材查询药膳

- **路径**：`/yaoshan/by-ingredient`
- **方法**：GET
- **描述**：根据输入的食材名称查询相关药膳
- **请求参数**（URL查询参数）：
  - `ingredient`：食材名称（如“枸杞”）
  - `pageNum`：页码（默认1）
  - `pageSize`：每页条数（默认10）
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "查询成功",
    "data": {
      "total": 5,
      "rows": [
        {
          "id": 105,
          "name": "枸杞菊花茶",
          "effect": "清肝明目",
          "ingredients": "枸杞、菊花、冰糖"
        }
      ]
    }
  }
  ```


### 3. 食材知识库接口

#### 3.1 食材详情查询

- **路径**：`/ingredient/detail`
- **方法**：GET
- **描述**：查询食材的性味、功效、适宜人群等信息
- **请求参数**（URL查询参数）：
  
  - `name`：食材名称（如“黄芪”）
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "查询成功",
    "data": {
      "name": "黄芪",
      "nature": "性温，味甘",
      "effect": "补气升阳，固表止汗",
      "suitable": "气虚乏力、易感冒人群",
      "taboo": "阴虚火旺者忌用"
    }
  }
  ```

#### 3.2 食材分类查询

- **路径**：`/ingredient/category`
- **方法**：GET
- **描述**：获取食材分类（如“补气类”“补血类”）
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "查询成功",
    "data": [
      {"id": 1, "name": "补气类"},
      {"id": 2, "name": "补血类"},
      {"id": 3, "name": "清热类"}
    ]
  }
  ```


### 4. 文件上传接口（头像/食材图片）

#### 4.1 上传图片
- **路径**：`/upload/image`
- **方法**：POST
- **描述**：上传图片至阿里云OSS（支持用户头像、自定义食材图片等）
- **请求头**：`authentication: Bearer {token}`（可选，游客可上传临时图片）
- **请求体**：`multipart/form-data` 格式，包含 `file` 字段（图片文件）
- **响应示例**：
  ```json
  {
    "code": 1,
    "msg": "上传成功",
    "data": {
      "url": "https://yaoshan-oss.aliyuncs.com/images/xxx.jpg"  // 图片访问URL
    }
  }
  ```


## 四、异常处理说明

| 错误码 | 常见场景     | 说明                                                         |
| ------ | ------------ | ------------------------------------------------------------ |
| 0      | 登录失败     | 微信code无效或服务器异常（对应`LoginFailedException`）       |
| 0      | 未登录       | 请求未携带Token或Token无效（对应`UserNotLoginException`）    |
| 0      | 密码错误     | 账号密码验证失败（对应`PasswordErrorException`）             |
| 0      | 文件上传失败 | OSS配置错误或文件格式异常（对应`MessageConstant.UPLOAD_FAILED`） |
| 0      | 系统繁忙     | 未知异常（对应`MessageConstant.UNKNOWN_ERROR`）              |


## 五、注意事项
1. 所有需登录的接口必须在请求头携带 `authentication: Bearer {token}`，Token有效期由配置文件 `jwt.expiration` 定义（默认7天）。
2. 个性化推荐依赖用户偏好设置，建议用户首次登录后完善 `physiqueTags` 等信息。
3. 食材和药膳数据可通过后台管理系统维护（当前接口暂未开放管理功能）。
4. 阿里云OSS配置需在 `application.yml` 中正确填写 `aliyun.oss` 相关参数，否则图片上传功能不可用。